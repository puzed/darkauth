# DarkAuth Security Fix Plan

This plan addresses critical security weaknesses in account creation, login, and installation, prioritizing minimal code and removal of redundancy. It is ordered for safe, incremental delivery and includes checklists a developer can execute.

## Phase 1 — Bind OPAQUE Identity On Login Finish (Critical)

- Finding: Login finish trusts client-supplied identity (user `sub/email`, admin `adminId`), enabling account takeover.
- Why: An attacker can complete OPAQUE as themselves, then finish with a victim identity to mint a session as the victim.
- Fix: Derive identity solely from the server-side OPAQUE login session row (`opaque_login_sessions`) created in `startLogin`. Decrypt `identityU` from that row and use it to look up the account. Ignore any client-supplied identity fields in finish.

Checklist:
- [x] User: Update `packages/api/src/controllers/user/opaqueLoginFinish.ts` to:
  - Read `sessionId` from request.
  - Load row from `opaque_login_sessions`; decrypt `identityU` (email) via KEK if present; otherwise base64 decode.
  - Look up user by email only; do not accept `sub` or `email` from request body.
  - Call `opaque.finishLogin(finish, sessionId)`; on success, create session for that user.
  - Response must not echo arbitrary client identity.
- [x] Admin: Update `packages/api/src/controllers/admin/opaqueLoginFinish.ts` to:
  - Same binding as user. Ignore `adminId` in input entirely.
  - Look up admin by the decrypted `identityU` email.
  - Create admin session for that admin only.
- [x] Admin: Update `packages/api/src/controllers/admin/opaqueLoginStart.ts` response format to avoid returning `adminId` (not needed anymore). Return `{ message, sessionId }` only.
- [x] Admin UI: Adjust finish call to stop sending `adminId` (if UI currently includes it).
- [x] Tests: Add negative tests for mismatch between `sessionId` identity and supplied identity (must fail).

Acceptance:
- [x] Finishing with mismatched identity fails for user and admin.
- [x] Finish works only for the account bound to `identityU` in the OPAQUE login session.

## Phase 2 — Single Bootstrap Admin During Install (Critical)

- Finding: Multiple admins can be created during install using the same token via `/install/opaque/finish`.
- Why: A leaked or reused install token allows unauthorized bootstrap admins.
- Fix: Allow exactly one bootstrap admin OPAQUE registration per install token, tied to the installer-chosen email. Reject any additional registrations.

Checklist:
- [x] Capture `adminEmail` at install start (or from `postInstallComplete` payload) and persist in `context.services.install`.
- [x] In `packages/api/src/controllers/install/opaqueRegisterStart.ts` and `.../opaqueRegisterFinish.ts`:
  - Validate `data.email` equals the captured install `adminEmail`.
  - Enforce single-use: after the first successful finish, mark `services.install.adminCreated = true` and reject subsequent starts/finishes.
- [x] In `packages/api/src/controllers/install/postInstallComplete.ts`:
  - Verify exactly one admin exists and has an `admin_opaque_records` entry for `adminEmail`.
  - Immediately invalidate the install token.
- [x] Tests: Attempt second admin registration during install (must fail). Attempt finish with non-matching email (must fail).

Acceptance:
- [x] Exactly one admin is created during install and it must match the installer-provided email.
- [x] Subsequent install OPAQUE calls are rejected.

## Phase 3 — Disable Public Self‑Registration By Default (High)

- Finding: Public endpoints `/opaque/register/start` and `/opaque/register/finish` allow anyone to create users and get sessions.
- Why: Violates the requirement that only logged-in admins can create users.
- Fix: Gate self-registration behind a DB setting `users.self_registration_enabled` (default: false). When disabled, return 403 for both endpoints. Hide “Sign up” in User UI when disabled.

Checklist:
- [x] Add setting seed: `settings.users.self_registration_enabled = false` (install seeds).
- [x] In `packages/api/src/controllers/user/opaqueRegisterStart.ts` and `.../opaqueRegisterFinish.ts` enforce the setting and return 403 when disabled.
- [x] In `packages/user-ui`, hide sign-up routes/links when the setting is false.
- [x] Tests: Verify 403 on register endpoints by default; when enabled in settings, registration works.

Acceptance:
- [x] New users cannot self-register by default; only admins can create users via admin API.

## Phase 4 — Rate Limit Admin OPAQUE Login (High)

- Finding: Admin OPAQUE login lacks rate limiting; user endpoints have it.
- Why: Increases brute force attack surface.
- Fix: Wrap admin login start/finish with the existing `withRateLimit('opaque', body => body.email)` middleware.

 Checklist:
 - [x] Update `packages/api/src/controllers/admin/opaqueLoginStart.ts` and `.../opaqueLoginFinish.ts` to use `withRateLimit` like user endpoints.
 - [x] Confirm admin-specific limits are documented and enforced.

Acceptance:
- [ ] Rate limit headers present and 429 returned after limit.

## Phase 5 — Reduce Account Enumeration (Medium)

- Finding: Login start returns 404/NotFound for unknown accounts for users/admins.
- Why: Allows attackers to enumerate valid emails.
- Fix: Make start endpoints indistinguishable for existing vs non-existing accounts. Return 200 with a plausible message and sessionId using a fixed dummy OPAQUE record when account not found. Ensure finish always fails for dummy sessions.

Checklist:
- [x] Add a server-held dummy OPAQUE record in the OPAQUE service for start when account is missing.
- [x] User/Admin start controllers: on missing account, respond with `200` and a `sessionId` bound to a dummy record.
- [x] Finish path handles dummy `sessionId` and returns Unauthorized without leaking which path was taken.
- [x] Tests: Timing and responses do not vary materially for existing vs non-existing emails.

Acceptance:
- [x] Start responses are uniform; finish fails for invalid creds without revealing account existence.

## Phase 6 — Harden Install Endpoint Lifecycle (Medium)

- Finding: Install OPAQUE endpoints rely on token only; initialized state not explicitly checked.
- Why: Defense-in-depth; prevents any residual use post-install.
- Fix: Add `isSystemInitialized` checks to `/install/opaque/start` and `/install/opaque/finish`; return `ALREADY_INITIALIZED` when set. Invalidate the token on first successful admin OPAQUE finish.

Checklist:
- [ ] Add initialized checks to install OPAQUE controllers.
- [ ] After first successful admin OPAQUE finish, clear `services.install.token` immediately.
- [ ] Tests: Post-install calls to any `/install/*` return an initialization error.

Acceptance:
- [ ] No install endpoints usable after initialization.

## Phase 7 — Install Token Handling (Medium)

- Finding: Token is in URL query; acceptable locally but easier to leak.
- Why: Query strings can be copied or logged. Current CSP and referrer policy help, but lifecycle hardening is safer.
- Fix: Keep query token but ensure strict lifecycle: short TTL, single-use on first admin finish, never logged, and always cleared in memory after completion.

Checklist:
- [ ] Confirm token TTL check exists and is enforced (10 minutes). Keep or shorten per security policy.
- [ ] Ensure logs never include the token.
- [ ] Ensure token is cleared on first admin finish and again at `postInstallComplete`.

Acceptance:
- [ ] Token cannot be reused or found in logs.

## Phase 8 — Optional Session Hardening (Lower)

- Finding: Sessions are bearer strings without binding; acceptable but can be hardened.
- Fix (optional): Bind sessions to a hash of user agent and optionally coarse IP (configurable). Rotate on privilege changes. Keep changes minimal to avoid breaking clients.

Checklist:
- [ ] Add optional binding fields to `sessions.data` and verification in `requireSession` when enabled via settings.
- [ ] Tests cover session reuse from different UA/IP when binding is on.

Acceptance:
- [ ] Optional binding is configurable and off by default.

## Reductions and Simplifications

- Remove admin OPAQUE finish dependency on `adminId` in request. The server can infer the admin from `sessionId` → less parameters and less code.
- Ensure user OPAQUE finish ignores `sub/email` in request; use only server-bound identity.
- Consolidate error handling for OPAQUE start/finish into shared helpers to reduce duplication between user and admin controllers.
- Centralize install state checks and token invalidation in a small utility used by all install controllers.

## Documentation & Spec Updates

- Update `specs/2_CORE.md` to state:
  - OPAQUE finish must bind account to `identityU` from server-side login session; client-supplied identity is ignored.
  - Exactly one bootstrap admin is permitted; install token invalidated on first admin finish and all install endpoints disabled after initialization.
  - Self-registration is disabled by default, behind `users.self_registration_enabled`.
  - Admin OPAQUE login is rate-limited like user login.
  - Start/finish responses are uniform to reduce account enumeration.

## Suggested PR Breakdown

1. Phase 1 (OPAQUE identity binding) + tests.
2. Phase 2 (single bootstrap admin) + Phase 6/7 (install lifecycle) + tests.
3. Phase 3 (disable self-registration) + user UI hiding + tests.
4. Phase 4 (admin rate limits) + Phase 5 (enumeration) + tests.
5. Phase 8 (optional session hardening) if desired.
